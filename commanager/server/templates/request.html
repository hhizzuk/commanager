<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Form</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/request.css') }}">
</head>
<body>
    <a href="{{ url_for('home') }}" class="back-button">‚Üê Back</a>
    <div class="Login_SignUp">
        <h2>Request Form</h2>

        <textarea id="message" placeholder="Enter your message here..." rows="6"></textarea>
        
        <!-- Local file input -->
        <div class="file-upload">
            <label for="file-input" class="file-label">Choose File</label>
            <input type="file" id="file-input">
            <span class="file-name">No file chosen</span>
        </div>
        
        <!-- Google Drive file input -->
        <div class="file-upload">
            <button type="button" id="drive-button" class="file-button">Choose File from Google Drive</button>
            <span class="file-name">No file chosen from Google Drive</span>
        </div>

        <p class="payment_continue">
            <div class="Button"><a href="{{ url_for('payment') }}" id="continue-btn">Continue</a></div>
        </p>
        <div id="error-message" class="error-message"></div>
    </div>

    <!-- Custom Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Submission</h3>
            <div id="modal-message"></div>
            <div class="modal-buttons">
                <button id="confirmBtn" class="modal-button confirm">Continue to Payment</button>
                <button id="cancelBtn" class="modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load the Google API Loader script. -->
    <script async defer src="https://apis.google.com/js/api.js" onload="onApiLoad()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        // Variables
        const messageInput = document.getElementById('message');
        const fileInput = document.getElementById('file-input');
        const continueBtn = document.getElementById('continue-btn');
        const errorMessage = document.getElementById('error-message');
        const modal = document.getElementById('confirmModal');
        const modalMessage = document.getElementById('modal-message');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        let selectedGoogleDriveFile = null;

        // Local file input event
        fileInput.addEventListener('change', function(e) {
            const fileName = e.target.files[0] ? e.target.files[0].name : 'No file chosen';
            document.querySelector('.file-name').textContent = fileName;
        });

        // Google Drive file picker function
        let tokenClient;
        let accessToken = null;
        let pickerInited = false;
        let gisInited = false;

        // Use the API Loader script to load google.picker
        function onApiLoad() {
            gapi.load('picker', onPickerApiLoad);
        }

        function onPickerApiLoad() {
            pickerInited = true;
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: '920660249919-knu2jfis93uq11bkmjq4vjb5bi5vsj0d.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/drive.readonly', 
                callback: '',  // Defined later
            });
            gisInited = true;
        }

        // Create and render a Google Picker object for selecting from Drive.
        function createPicker() {
            const showPicker = () => {
                const picker = new google.picker.PickerBuilder()
                    .addView(google.picker.ViewId.DOCS)
                    .setOAuthToken(accessToken)
                    .setDeveloperKey('AIzaSyCVgGUmhYrvqECS54QhnthjMNx-jaLv158')
                    .setCallback(pickerCallback)
                    .setAppId('920660249919')
                    .build();
                picker.setVisible(true);
            }

            // Request an access token.
            tokenClient.callback = async (response) => {
                if (response.error !== undefined) {
                    throw (response);
                }
                accessToken = response.access_token;
                showPicker();
            };

            if (accessToken === null) {
                // Prompt the user to select a Google Account and ask for consent to share their data
                // when establishing a new session.
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                // Skip display of account chooser and consent dialog for an existing session.
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        // A simple callback implementation.
        function pickerCallback(data) {
            if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
                const doc = data[google.picker.Response.DOCUMENTS][0];

                selectedGoogleDriveFile = {
                    name: doc.name,
                    url: doc.url,
                    id: doc.id
                };

                // Update the UI
                const driveFileLabel = document.querySelectorAll('.file-name')[1];  // second one
                driveFileLabel.textContent = doc.name;

                console.log("Selected file from Drive:", doc);
            }
        }

        // Continue button behavior
        continueBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!messageInput.value.trim() && !fileInput.files.length && !selectedGoogleDriveFile) {
                errorMessage.textContent = 'Please enter a message or upload a file';
                errorMessage.style.display = 'block';
                return;
            }
            errorMessage.style.display = 'none';

            const messageText = messageInput.value.trim() 
                ? `<p><strong>Message:</strong> ${messageInput.value}</p>` 
                : '<p><strong>Message:</strong> No message provided</p>';
            const fileText = fileInput.files.length 
                ? `<p><strong>File:</strong> ${fileInput.files[0].name}</p>` 
                : selectedGoogleDriveFile 
                    ? `<p><strong>File from Google Drive:</strong> ${selectedGoogleDriveFile.name}</p>`
                    : '<p><strong>File:</strong> No file uploaded</p>';

            modalMessage.innerHTML = messageText + fileText;
            modal.style.display = 'flex';
        });

        confirmBtn.addEventListener('click', function() {
            window.location.href = "{{ url_for('payment') }}";
        });

        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        document.getElementById('drive-button').addEventListener('click', function () {
            if (pickerInited && gisInited) {
                createPicker();
            } else {
                alert("Google Drive is not fully initialized yet. Please wait a moment and try again.");
            }
        });
    </script>
</body>
</html>